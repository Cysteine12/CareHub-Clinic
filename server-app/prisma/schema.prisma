// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Patient {
  id                        String    @id @default(uuid())
  email                     String    @unique
  password                  String
  is_verified               Boolean   @default(false)
  has_calendar_access       Boolean?
  first_name                String
  last_name                 String
  phone                     String
  image_url                 String?
  date_of_birth             DateTime
  address                   String
  gender                    PatientGender
  emergency_contact_name    String
  emergency_contact_phone   String
  blood_group               String
  allergies                 String[]
  insurance_provider_id     String?
  insurance_coverage        String?
  created_at                DateTime  @default(now())
  updated_at                DateTime  @updatedAt
  appointments              Appointment[]
  calendar_tokens           CalendarToken[]
  insurance_provider        InsuranceProvider? @relation(fields: [insurance_provider_id], references: [id])

  @@map("patients")
}

enum PatientGender {
  MALE
  FEMALE
}

model Provider {
  id                    String            @id @default(uuid())
  email                 String            @unique
  password              String
  first_name            String
  last_name             String
  phone                 String
  role_title            ProviderRoleTitle
  created_at            DateTime          @default(now())
  updated_at            DateTime          @updatedAt

  appointment_providers AppointmentProvider[]
  soap_notes            SoapNote[]
  vitals                Vital[]      
  events                Event[]          

  role                  ProviderRole      @relation(fields: [role_title], references: [title])

  @@map("providers")
}

model ProviderRole {
  id                    String              @id @default(uuid())
  title                 ProviderRoleTitle   @unique
  description           String
  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt

  providers             Provider[]

  @@map("provider_roles")
}

enum ProviderRoleTitle {
  ADMIN                 @map("ADMIN")
  GENERAL_PRACTIONER    @map("GENERAL PRACTIONER")
  NURSE                 @map("NURSE")
  PHARMACIST            @map("PHARMACIST")
  LAB_TECHNICIAN        @map("LAB TECHNICIAN")
  PAEDIATRICIAN         @map("PAEDIATRICIAN")
  GYNAECOLOGIST         @map("GYNAECOLOGIST")
  RECEPTIONIST          @map("RECEPTIONIST")
}

model Session {
  sid                   String        @id
  sess                  Json
  expire                DateTime      @db.Timestamp(6)

  @@map("session")
  @@index([expire])
}

model Token {
  id                    String         @id   @default(uuid())
  email                 String         @unique
  otp                   String
  type                  TokenType
  expires_at            DateTime

  @@map("tokens")
}

enum TokenType {
  VERIFY_EMAIL
  CHANGE_PASSWORD
}

model Appointment {
  id                       String                       @id @default(uuid())
  patient_id               String
  schedule                 Json
  purposes                 AppointmentPurpose[]
  other_purpose            String?
  status                   AppointmentStatus            @default(SUBMITTED)
  has_insurance            Boolean?
  is_follow_up_required    Boolean?                     @default(false)
  followed_up_appointment_id String?                    @unique                  
  calendar_event_id        String?
  created_at               DateTime                     @default(now())
  updated_at               DateTime                     @updatedAt

  events                   Event[]
  soap_notes               SoapNote[]
  appointment_providers    AppointmentProvider[]

  patient                  Patient                      @relation(fields: [patient_id], references: [id])
  vital                    Vital? 
  follow_up_appointment    Appointment?                 @relation("FollowUpAppointment")
  followed_up_appointment  Appointment?                 @relation("FollowUpAppointment", fields: [followed_up_appointment_id], references: [id])

  @@map("appointments")
}

enum AppointmentPurpose {
  ROUTINE_HEALTH_CHECKUP                  @map("ROUTINE HEALTH CHECKUP")
  MEDICAL_CONSULTATION_AND_TREATMENT      @map("MEDICAL CONSULTATION AND TREATMENT")
  FOLLOWUP_APPOINTMENT                    @map("FOLLOWUP APPOINTMENT")
  MATERNAL_CHILD_HEALTH                   @map("MATERNAL & CHILD HEALTH")
  IMMUNIZATIONS_AND_VACCINATIONS          @map("IMMUNIZATIONS AND VACCINATIONS")
  FAMILY_PLANNING                         @map("FAMILY PLANNING")
  HIV_AIDS_COUNSELING_AND_TESTING         @map("HIV AIDS COUNSELING AND TESTING")
  TUBERCULOSIS_SCREENING_AND_TREATMENT    @map("TUBERCULOSIS SCREENING AND TREATMENT")
  NUTRITION_COUNSELING_AND_SUPPORT        @map("NUTRITION COUNSELING AND SUPPORT")
  CHRONIC_DISEASE_MANAGEMENT              @map("CHRONIC DISEASE MANAGEMENT")
  MENTAL_HEALTH_SUPPORT_OR_COUNSELING     @map("MENTAL HEALTH SUPPORT OR COUNSELING")
  HEALTH_EDUCATION_AND_AWARENESS          @map("HEALTH EDUCATION AND AWARENESS")
  ANTENATAL_OR_POSTNATAL_CARE             @map("ANTENATAL OR POSTNATAL CARE")
  SEXUAL_AND_REPRODUCTIVE_HEALTH_SERVICES @map("SEXUAL AND REPRODUCTIVE HEALTH SERVICES")
  MALARIA_DIAGNOSIS_AND_TREATMENT         @map("MALARIA DIAGNOSIS AND TREATMENT")
  HEALTH_SCREENING_CAMPAIGNS              @map("HEALTH SCREENING CAMPAIGNS")
  DRUG_OR_SUBSTANCE_ABUSE_COUNSELING      @map("DRUG OR SUBSTANCE ABUSE COUNSELING")
  DENTAL_CARE                             @map("DENTAL CARE")
  REFERRAL
  OTHERS
}

enum AppointmentStatus {
  SUBMITTED
  SCHEDULED
  CHECKED_IN    @map("CHECKED IN")
  CANCELLED
  RESCHEDULED
  ATTENDING
  ATTENDED
  NO_SHOW       @map("NO SHOW")
  COMPLETED
  CONFIRMED
}

model AppointmentProvider {
  id              String      @id @default(uuid())
  appointment_id  String
  provider_id     String
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt

  provider        Provider    @relation(fields: [provider_id], references: [id])
  appointment     Appointment @relation(fields: [appointment_id], references: [id])

  @@unique([appointment_id, provider_id])
  @@map("appointment_providers")
}

model SoapNote {
  id             String       @id @default(uuid())
  appointment_id String
  subjective     Json?
  objective      Json?
  assessment     Json?
  plan           Json?
  created_by_id  String
  created_at     DateTime     @default(now())
  updated_at     DateTime     @updatedAt

  events         Event[]

  created_by     Provider     @relation(fields: [created_by_id], references: [id])
  appointment    Appointment  @relation(fields: [appointment_id], references: [id])

  @@map("soap_notes")
}

model Vital {
  id                      String      @id @default(uuid())
  blood_pressure          String?
  heart_rate              String?
  temperature             String?
  height                  String?
  weight                  String?
  respiratory_rate        String?
  oxygen_saturation       String?
  bmi                     String?
  others                  String?
  appointment_id          String      @unique
  created_by_id           String
  created_at              DateTime    @default(now())
  updated_at              DateTime    @updatedAt

  events                  Event[]

  created_by              Provider    @relation(fields: [created_by_id], references: [id])
  appointment             Appointment @relation(fields: [appointment_id], references: [id])

  @@map("vitals")
}

model Event {
  id            String              @id @default(uuid())
  type          EventType
  appointment_id String
  created_by_id String
  status        String?
  vital_id      String?
  soap_note_id  String?
  created_at    DateTime            @default(now())
  updated_at    DateTime            @updatedAt

  appointment   Appointment         @relation(fields: [appointment_id], references: [id])
  created_by    Provider            @relation(fields: [created_by_id], references: [id])
  soap_note     SoapNote?           @relation(fields: [soap_note_id], references: [id])
  vitals        Vital?              @relation(fields: [vital_id], references: [id])

  @@map("events")
}

enum EventType {
  VITALS_RECORDED               @map("VITALS RECORDED")
  VITALS_UPDATED                @map("VITALS UPDATED")
  SOAP_NOTE_RECORDED            @map("SOAP NOTE RECORDED")
  SOAP_NOTE_UPDATED             @map("SOAP NOTE UPDATED")
  APPOINTMENT_STATUS_CHANGED    @map("APPOINTMENT STATUS CHANGED")
}

model InsuranceProvider {
  id            String          @id @default(uuid())
  name          String
  description   String
  created_at    DateTime        @default(now())
  updated_at    DateTime        @updatedAt

  patients      Patient[]

  @@map("insurance_providers")
}

model CalendarToken {
  id            String          @id @default(uuid())
  tokens        Json
  patient_id    String          @unique
  created_at    DateTime        @default(now())
  updated_at    DateTime        @updatedAt

  patient       Patient         @relation(fields: [patient_id], references: [id])

  @@map("calendar_tokens")
}
